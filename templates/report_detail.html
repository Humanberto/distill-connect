<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Details</title>
    <style>
        th {
            cursor: pointer;
            position: relative;
        }

        th.sort-indicator {
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }

        th.sort-indicator.asc::before {
            content: '▲';
        }

        th.sort-indicator.desc::before {
            content: '▼';
        }
    </style>
</head>

<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="container">
        <h1 class="mt-4">Report Details</h1>
        <p><strong>Title:</strong> {{ report.title }}</p>
        <p><strong>Date:</strong> {{ report.date }}</p>
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search for items...">
        <table class="table table-striped" id="reportTable">
            <thead>
                <tr>
                    {% for header in report.details[0] %}
                    <th onclick="sortTable({{ loop.index0 }})">{{ header }}
                        <span id="sortIndicator-{{ loop.index0 }}" class="sort-indicator"></span>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in report.details[1:] %}
                <tr data-index="{{ loop.index0 }}">
                    {% for cell in row %}
                    {% if loop.index == 6 %}
                    <td><input type="number" name="par-{{ loop.parent.index0 }}" value="{{ cell }}" onchange="updateTotal({{ loop.parent.index0 }})"></td>
                    {% elif loop.index == 7 %}
                    <td><input type="number" name="pos-{{ loop.parent.index0 }}" value="{{ cell }}" onchange="updateTotal({{ loop.parent.index0 }})"></td>
                    {% else %}
                    <td>{{ cell }}</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-primary" onclick="submitUpdates()">Update</button>
        <form method="POST" action="{{ url_for('delete_report_route', report_id=report.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
    {% endblock %}
</body>

<script>
    let sortDirection = true;

    function sortTable(columnIndex) {
        const table = document.getElementById("reportTable");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
            const cellA = a.cells[columnIndex].innerText;
            const cellB = b.cells[columnIndex].innerText;
            if (sortDirection) {
                return cellA.localeCompare(cellB, undefined, { numeric: true });
            } else {
                return cellB.localeCompare(cellA, undefined, { numeric: true });
            }
        });

        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        rows.forEach(row => tbody.appendChild(row));

        sortDirection = !sortDirection;
        updateSortIndicators(columnIndex);
    }

    function updateSortIndicators(columnIndex) {
        const indicators = document.querySelectorAll('.sort-indicator');
        indicators.forEach(indicator => indicator.innerText = '');

        const currentIndicator = document.getElementById(`sortIndicator-${columnIndex}`);
        currentIndicator.innerText = sortDirection ? '▲' : '▼';
    }

    function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("reportTable");
        const rows = Array.from(table.tBodies[0].rows);

        rows.forEach(row => {
            const cells = Array.from(row.cells);
            const match = cells.some(cell => cell.innerText.toLowerCase().includes(filter));
            row.style.display = match ? "" : "none";
        });
    }

    function updateTotal(rowIndex) {
        const row = document.querySelector(`#reportTable tbody tr[data-index="${rowIndex}"]`);
        const countCell = row.cells[4];
        const parInput = row.querySelector(`input[name="par-${rowIndex}"]`);
        const posInput = row.querySelector(`input[name="pos-${rowIndex}"]`);
        const totalCell = row.cells[8];

        const count = parseFloat(countCell.innerText) || 0;
        const par = parseFloat(parInput.value) || 0;
        const pos = parseFloat(posInput.value) || 0;

        totalCell.innerText = count - par - pos;
    }

    function submitUpdates() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';

        document.querySelectorAll('#reportTable input').forEach(input => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = input.name;
            hiddenInput.value = input.value;
            form.appendChild(hiddenInput);
        });

        document.body.appendChild(form);
        form.submit();
    }
</script>

</html>
